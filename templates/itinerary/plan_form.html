{% extends "base.html" %}
{% block title %}Plan My Trip ‚Äî Tourist Assist{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .planner-hero {
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.12) 0%, rgba(139, 92, 246, 0.12) 100%);
        border-radius: 24px;
        padding: 2.5rem 2rem 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--glass-border);
    }

    .section-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 18px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        backdrop-filter: blur(10px);
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--accent-color);
        margin-bottom: 1.2rem;
    }

    .form-control {
        background: rgba(255, 255, 255, 0.12) !important;
        border: 1px solid var(--glass-border) !important;
        color: #ffffff !important;
        border-radius: 12px !important;
        transition: all 0.3s ease;
    }

    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5) !important;
    }

    /* Fix for date inputs to ensure text is visible */
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }

    .form-control:focus {
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2) !important;
        border-color: var(--accent-color) !important;
    }

    .form-control::placeholder {
        color: var(--text-dim) !important;
    }

    .budget-options {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .budget-label {
        flex: 1;
        min-width: 130px;
        border: 2px solid var(--glass-border);
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.25s;
        text-align: center;
    }

    .budget-radio {
        display: none;
    }

    .budget-radio:checked+.budget-label {
        border-color: var(--accent-color);
        background: rgba(56, 189, 248, 0.1);
    }

    .budget-label:hover {
        border-color: rgba(56, 189, 248, 0.5);
    }

    .interests-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.75rem;
    }

    .interest-item input[type="checkbox"] {
        display: none;
    }

    .interest-chip {
        border: 2px solid var(--glass-border);
        border-radius: 10px;
        padding: 0.65rem 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        font-size: 0.88rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3rem;
    }

    .chip-icon {
        font-size: 1.5rem;
    }

    .interest-item input[type="checkbox"]:checked+.interest-chip {
        border-color: var(--accent-color);
        background: rgba(56, 189, 248, 0.1);
        color: var(--accent-color);
    }

    .interest-chip:hover {
        border-color: rgba(56, 189, 248, 0.4);
    }

    .btn-generate {
        background: linear-gradient(135deg, #38bdf8, #818cf8);
        border: none;
        border-radius: 12px;
        padding: 0.85rem 2.5rem;
        font-size: 1.05rem;
        font-weight: 600;
        color: white;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .btn-generate:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(56, 189, 248, 0.35);
    }

    .errorlist {
        list-style: none;
        padding: 0;
        margin: 0.4rem 0 0;
        color: #f87171;
        font-size: 0.85rem;
    }

    .field-label {
        color: var(--text-dim);
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div style="width:100%;max-width:860px;padding:1rem 0 3rem;">

    <div class="planner-hero">
        <h1 style="font-size:2rem;font-weight:700;margin-bottom:0.4rem;">Plan Your Custom Trip</h1>
        <p style="color:var(--text-dim);margin:0;">Tell us your preferences and we will build the perfect day-by-day
            itinerary for you.</p>
    </div>

    {% if messages %}
    {% for msg in messages %}
    <div
        style="border-radius:12px;margin-bottom:1rem;padding:1rem;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);color:#fbbf24;">
        {{ msg }}</div>
    {% endfor %}
    {% endif %}

    <form method="POST" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div
            style="border-radius:12px;margin-bottom:1rem;padding:1rem;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#f87171;">
            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}

        <!-- Where & When -->
        <div class="section-card">
            <div class="section-title">Where &amp; When</div>
            <div class="row g-3">
                <div class="col-md-12">
                    <label class="field-label" for="{{ form.destination.id_for_label }}">Destination</label>
                    {{ form.destination }}
                    {% if form.destination.errors %}
                    <ul class="errorlist">{% for e in form.destination.errors %}<li>{{ e }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label class="field-label" for="{{ form.num_days.id_for_label }}">Number of Days</label>
                    {{ form.num_days }}
                    {% if form.num_days.errors %}
                    <ul class="errorlist">{% for e in form.num_days.errors %}<li>{{ e }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label class="field-label" for="{{ form.start_date.id_for_label }}">Start Date</label>
                    {{ form.start_date }}
                    {% if form.start_date.errors %}
                    <ul class="errorlist">{% for e in form.start_date.errors %}<li>{{ e }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label class="field-label" for="{{ form.end_date.id_for_label }}">End Date</label>
                    {{ form.end_date }}
                    {% if form.end_date.errors %}
                    <ul class="errorlist">{% for e in form.end_date.errors %}<li>{{ e }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Budget Range (Generator Filter) -->
        <div class="section-card">
            <div class="section-title">Budget Range</div>
            <div class="budget-options">
                <div>
                    <input type="radio" name="budget" id="budget_economy" value="economy" class="budget-radio">
                    <label for="budget_economy" class="budget-label">
                        <div class="chip-icon">&#x1F392;</div>
                        <div style="font-weight:600;color:var(--text-main);">Economy</div>
                        <div style="font-size:0.78rem;color:var(--text-dim);">&#8377;0 &#8211; &#8377;500/day</div>
                    </label>
                </div>
                <div>
                    <input type="radio" name="budget" id="budget_moderate" value="moderate" class="budget-radio"
                        checked>
                    <label for="budget_moderate" class="budget-label">
                        <div class="chip-icon">&#x1F9F3;</div>
                        <div style="font-weight:600;color:var(--text-main);">Moderate</div>
                        <div style="font-size:0.78rem;color:var(--text-dim);">&#8377;500 &#8211; &#8377;2000/day</div>
                    </label>
                </div>
                <div>
                    <input type="radio" name="budget" id="budget_luxury" value="luxury" class="budget-radio">
                    <label for="budget_luxury" class="budget-label">
                        <div class="chip-icon">&#x1F48E;</div>
                        <div style="font-weight:600;color:var(--text-main);">Luxury</div>
                        <div style="font-size:0.78rem;color:var(--text-dim);">&#8377;2000+/day</div>
                    </label>
                </div>
            </div>
            {% if form.budget.errors %}
            <ul class="errorlist" style="margin-top:.7rem;">
                {% for e in form.budget.errors %}<li>{{ e }}</li>{% endfor %}
            </ul>
            {% endif %}
        </div>

        <!-- Estimated Budget Details -->
        <div class="section-card">
            <div class="section-title">üí∞ Estimated Extra Costs (Optional)</div>
            <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1.2rem;">
                Enter estimated costs for accommodation, transport and food to get a total trip budget.
            </p>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="field-label" for="{{ budget_form.hotel_cost.id_for_label }}">üè® Hotel Cost (‚Çπ)</label>
                    {{ budget_form.hotel_cost }}
                    {% if budget_form.hotel_cost.errors %}
                    <ul class="errorlist">{% for e in budget_form.hotel_cost.errors %}<li>{{ e }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label class="field-label" for="{{ budget_form.transport_cost.id_for_label }}">üöó Transport Cost
                        (‚Çπ)</label>
                    {{ budget_form.transport_cost }}
                    {% if budget_form.transport_cost.errors %}
                    <ul class="errorlist">{% for e in budget_form.transport_cost.errors %}<li>{{ e }}</li>{% endfor %}
                    </ul>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label class="field-label" for="{{ budget_form.food_cost.id_for_label }}">üçΩÔ∏è Food Cost (‚Çπ)</label>
                    {{ budget_form.food_cost }}
                    {% if budget_form.food_cost.errors %}
                    <ul class="errorlist">{% for e in budget_form.food_cost.errors %}<li>{{ e }}</li>{% endfor %}</ul>
                    {% endif %}
                </div>
            </div>

            <!-- Live Total Display -->
            <div
                style="margin-top: 1.5rem; padding: 1rem; background: rgba(56, 189, 248, 0.08); border-radius: 12px; border: 1px dashed var(--accent-color); display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: var(--text-dim);">Estimated Total Additional:</span>
                <span id="live_total"
                    style="font-size: 1.2rem; font-weight: 700; color: var(--accent-color);">‚Çπ0.00</span>
            </div>
        </div>

        <div style="text-align:center;margin-top:1rem;">
            <button type="submit" class="btn-generate">Generate My Itinerary</button>
        </div>
    </form>

    {% if user.is_authenticated %}
    <div style="text-align:center;margin-top:1.5rem;">
        <a href="{% url 'itinerary-list' %}" style="color:var(--text-dim);font-size:0.9rem;">View My Saved
            Itineraries</a>
    </div>
    {% endif %}

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Restore budget selection from POST
    (function () {
        var budgetVal = "{{ form.budget.value|default:'moderate' }}";
        var radio = document.getElementById('budget_' + budgetVal);
        if (radio) radio.checked = true;

        // Live Total Calculator
        const hotelInput = document.getElementById('id_hotel_cost');
        const transportInput = document.getElementById('id_transport_cost');
        const foodInput = document.getElementById('id_food_cost');
        const totalDisplay = document.getElementById('live_total');

        function updateTotal() {
            const h = parseFloat(hotelInput.value) || 0;
            const t = parseFloat(transportInput.value) || 0;
            const f = parseFloat(foodInput.value) || 0;
            const total = h + t + f;
            totalDisplay.innerText = '‚Çπ' + total.toLocaleString('en-IN', { minimumFractionDigits: 2 });
        }

        [hotelInput, transportInput, foodInput].forEach(input => {
            if (input) input.addEventListener('input', updateTotal);
        });

        // Initialize display
        if (hotelInput) updateTotal();
    })();
</script>
{% endblock %}